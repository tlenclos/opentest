$(function() {
    // Utils
    var transformToLink = function(href) {
        var l = document.createElement("a");
        l.href = href;
        return l;
    };

    // Start a pentest
    var rawUrl = $('#pentest_url').val();
    var website = transformToLink(rawUrl).hostname;
    var newPenTestForm = $('#start-pentest-form');
    var submitPenTestBtn = $('#submit-pentest');
    var messagesBox = $('#messages');
    var htmlSuccess = function(text) { return '<p class="alert-success">'+ text +'</p>' };
    var htmlFail = function(text) { return '<p class="alert-error">'+ text +'</p>' };

    newPenTestForm.submit(function( event ) {
        event.preventDefault();
        var data = $(this).serializeArray();

        var request = $.ajax({
            url: INDEX+"add-pentest/"+website,
            type: "POST",
            data: data
        });

        submitPenTestBtn.text('Démarrage du pentest...');

        request.done(function( response ) {
            try {
                messagesBox.append(htmlSuccess(response.msg));
                submitPenTestBtn.text('Démarrer');
            } catch (e) {
                console.log(e);
            }
        });

        request.fail(function( jqXHR, textStatus ) {
            try {
                var json = JSON.parse(jqXHR.responseText);
                messagesBox.append(htmlFail('Erreur: '+json.msg.join(' ')));
                submitPenTestBtn.text('Démarrer');
            } catch (e) {
                console.log(e);
            }
        });
    });

    // Websocket
    if (typeof io !== 'undefined') {
        var socket = io.connect(SOCKET_IO_URL);

        socket.on('log', function (data) {
            try {
                var json = JSON.parse(data);
                console.log(json);
                writeToTerminal(json.pid, json.command, json.stdout, json.stderr, json.success);
            } catch (e) {}
        });
    }

    function writeToTerminal(pid, command, stdout, stderr, success) {
        var container = $('#running-commands'),
            identifier = 'running-command-' + pid,
            elem = $('#' + identifier + ' .terminal'),
            terminal
        ;

        if (!container.length) {
            return false;
        }

        if (!elem.length) {
            var accordionGroup = '<div class="accordion-group alert-info">' +
                '<div class="accordion-heading">' +
                    '<a class="accordion-toggle" data-toggle="collapse" data-parent="' + container.selector + '" href="#' + identifier + '">' + command + '</a>' +
                '</div>' +
                '<div id="' + identifier + '" class="accordion-body collapse">' +
                    '<div class="accordion-inner" />' +
                '</div>' +
            '</div>';

            container.append(accordionGroup);
            elem = $('#' + identifier + ' .accordion-inner');

            terminal = elem.terminal(
                $.noop,
                {
                    greetings: '[[b;#00ee11;#000]' + command + ']',
                    name: identifier,
                    enabled: false
                }
            );
        } else {
            // State
            if (success == true) {

            } else if (success == false) {

            }

            // Write to terminal
            terminal = elem.data('terminal');
        }

        if (false !== stdout) {
            terminal.echo(_.escape(stdout));
        }

        if (false !== stderr) {
            terminal.error(_.escape(stderr));
        }
    }
});